### APIView

- 属性
  - renderer_classes
  - parser_classes
  - authentication_classes
  - throttle_classes
  - permission_classes
  - content_negotiation
  - metadata_class
  - versioning_class
  - settings
  - schema
- 函数
  - as_view
    - 入口
    - queryset判定
      - 保证我们数据都是自己根据条件获取
      - 不能和其它请求出现数据混乱
    - 调用父类中的as_view
      - 检查关键字参数的key
        - 不能是请求方法
        - 必须是存在的属性
      - 定义了闭包函数view
        - 创建自己的对象并记录数据
        - dispatch
          - 会执行子类中的dispatch（APIView）
  - allowed_methods
  - default_response_headers
  - http_method_not_allowed
  - permission_denied
    - 来源check_permission
    - 抛出异常
      - APIException子类
  - throttled
    - 来源check_throttles
    - 直接抛出异常
  - get_authenticate_header
  - get_parser_context
    - 来源initialize_request
    - 构建了一个字典
    - 字典中包含类对象，args，kwargs
  - get_renderer_context
  - get_exception_hanlder_context
  - get_view_name
  - get_view_description
  - get_format_suffix
    - 来源initial
    - 获取格式化后缀
    - 从settings中获取，（DRF的settings）
  - get_renderers
    - 来源perform_content_negotiation
    - 返回列表生成式
    - 转换器对象列表
  - get_parsers
    - 来源initialize_request
    - 返回列表生成式
    - 返回的是解析器对象的列表
  - get_authenticators
    - 来源initialize_request
    - 返回列表生成式
    - 返回的是认证器对象列表
  - get_permissions
    - 来源check_permission
    - 返回列表生成式
    - 返回的是权限对象列表
  - get_throttles
    - 来源check_throttles
    - 返回列表生成式
    - 返回的是节流器对象列表
  - get_content_negotiator
    - 来源initialize_request， perform_content_negotiation
    - 获取是否存在决策器
    - 如果存在直接返回
    - 如果不存在，去获取，然后存上
    - 缓存机制
      - 多次使用
  - get_exception_handler
  - perform_content_negotiation
    - 来源initial
    - get_renderers
    - get_content_negotiator
    - 使用既有决策进行渲染的抉择
  - perform_authentication
    - 来源initial
    - request.user 就完成认证了？
    - 真的完成了，借助描述器（property）
    - 调用属性，实际调用的是函数
    - 认证跑到Request中执行
    - request._authenticate
      - 认证器遍历
        - 是从APIView中拿的
        - 调用authenticate认证方法
        - 认证会返回认证元组
        - 认证成功返回的元组是user和auth
        - 如果认证过程中不出现异常
          - 会逐一认证，只要有一个认证成功，就停止认证
          - 如果都没有认证成功，就是没认证
  - check_permissions
    - 来源initial
    - 权限器的遍历
    - get_permissions
    - permission_denied
    - 调用has_permission检测方法
    - 如果有就行下一个权限检查
    - 如果有一个不满足，就权限被拒绝
  - check_object_permission
  - check_throttles
    - 来源initial
    - 节流器遍历
    - get_throttles
    - throttled
    - 调用allow_request判定
    - 如果有一个不允许，就节流
    - 如果允许就直接通过
  - determine_version
    - 来源initial
    - 判断versioning_class
    - 返回元组
      - version
        - versioning_class.determin_version
      - schema
  - initialize_request
    - 来源dispatch
    - 构建了一个新的Request
      - get_parser_context
      - get_parsers
      - get_authenticators
      - get_content_negotiator
  - finalize_response
  - handle_exception
  - raise_uncaught_exception
  - dispatch
    - 从as_view中调用
    - initialize_request
      - 获取转换内容
      - 构建了一个新的Request
        - get_parser_context
        - get_parsers
        - get_authenticators
        - get_content_negotiator
    - 记录request
    - 获取默认响应头
    - initial
      - get_format_suffix
      - perform_content_negotiation
      - determin_version
      - perform_authentication
      - check_permissions
      - check_throttles
    - 根据请求方法进行分发
      - 得到响应
        - 开发者书写的
      - 如果响应出现异常
        - handle_exception
          - 系统生成
          - get_exception_handler
            - 从settings中获取的异常处理的处理者
          - get_exception_handler_context
            - 字典结构
            - view
            - args
            - kwargs
            - request
          - 调用exception_handler去处理上下文和异常信息
          - 如果没有生成response
            - 会抛raise_uncaught_exception
              - 根据是否是debug模式
              - 如果有调试模式，会携带错误信息
              - 不是debug，直接抛异常，没有信息
          - 如果有response生成，添加了标记，返回response
    - 一定会得到response
    - finalize_response
      - 最终还是统一处理（uncaught除外）
      - 根据你能接受的类型进行统一处理
  - options

