import requests
from lxml import etree
import urllib.request
from shibie import shibie
import time

# åˆ›å»ºä¸€ä¸ªä¼šè¯
s = requests.Session()

headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36'
}

i = 0
while 1:
    # å…ˆå‘é€getè¯·æ±‚ï¼Œè·å–éªŒè¯ç å›¾ç‰‡åœ°å€ï¼Œå°†å›¾ç‰‡ä¸‹è½½åˆ°æœ¬åœ°
    get_url = 'https://so.gushiwen.org/user/login.aspx?from=http://so.gushiwen.org/user/collect.aspx'
    r_get = s.get(url=get_url, headers=headers)
    tree = etree.HTML(r_get.text)
    image_src = 'https://so.gushiwen.org' + tree.xpath('//img[@id="imgCode"]/@src')[0]
    # è·å–è¡¨å•é‡Œé¢ä¸¤ä¸ªéšè—æ¡†çš„å€¼
    views = tree.xpath('//input[@id="__VIEWSTATE"]/@value')[0]
    viewg = tree.xpath('//input[@id="__VIEWSTATEGENERATOR"]/@value')[0]
    # ä¸‹è½½éªŒè¯ç å›¾ç‰‡
    # urllib.request.urlretrieve(image_src, 'code.png')
    r_image = s.get(url=image_src, headers=headers)
    with open('code.png', 'wb') as fp:
        fp.write(r_image.content)
    # è®©è½¯ä»¶è‡ªåŠ¨è¯†åˆ«éªŒè¯ç 
    code = shibie('./code.png')

    # æ¨¡æ‹Ÿå‘é€postè¯·æ±‚
    post_url = 'https://so.gushiwen.org/user/login.aspx?from=http%3a%2f%2fso.gushiwen.org%2fuser%2fcollect.aspx'
    formdata = {
        '__VIEWSTATE': views, 
        '__VIEWSTATEGENERATOR': viewg, 
        'from': 'http://so.gushiwen.org/user/collect.aspx', 
        'email': '1090509990@qq.com', 
        'pwd': '123456', 
        'code': code, 
        'denglu': 'ç™»å½•', 
    }
    r_post = s.post(url=post_url, headers=headers, data=formdata)

    i += 1
    # å¦‚æœè¯†åˆ«æ­£ç¡®ï¼Œæ¨å‡ºå¾ªç¯ï¼Œè¯†åˆ«å¤±è´¥ï¼Œæ¥ç€è¯†åˆ«
    if 'é€€å‡ºç™»å½•' in r_post.text:
        print('ç¬¬--%s--æ¬¡è¯†åˆ«æˆåŠŸ-ğŸ˜Š' % i)
        break
    print('ç¬¬--%s--æ¬¡è¯†åˆ«å¤±è´¥-ğŸ˜­' % i)
    time.sleep(2)